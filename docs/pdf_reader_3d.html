<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D PDF Reader with Page Flip Animation</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-x: hidden;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .upload-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 20px 0;
        }

        .file-input {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .file-input-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .pdf-container {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 1200px;
        }

        .book-container {
            perspective: 1200px;
            perspective-origin: center center;
            width: 100%;
            max-width: 900px;
            height: 600px;
            position: relative;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .book {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .page {
            position: absolute;
            width: 45%;
            height: 90%;
            background: white;
            border: 2px solid #ddd;
            box-shadow: 0 5px 25px rgba(0,0,0,0.4);
            transform-style: preserve-3d;
            transition: transform 0.6s ease-in-out;
            backface-visibility: hidden;
            border-radius: 5px;
            opacity: 1;
        }

        .page.left {
            left: 2.5%;
            z-index: 2;
            transform-origin: right center;
        }

        .page.right {
            right: 2.5%;
            z-index: 1;
            transform-origin: left center;
        }

        .page.flipping {
            z-index: 10;
        }

        .page.flipping.left {
            animation: flipLeft 0.6s ease-in-out forwards;
        }

        .page.flipping.right {
            animation: flipRight 0.6s ease-in-out forwards;
        }

        @keyframes flipLeft {
            0% {
                transform: rotateY(0deg);
            }
            25% {
                transform: rotateY(45deg);
            }
            50% {
                transform: rotateY(90deg);
            }
            75% {
                transform: rotateY(135deg);
            }
            100% {
                transform: rotateY(180deg);
            }
        }

        @keyframes flipRight {
            0% {
                transform: rotateY(0deg);
            }
            25% {
                transform: rotateY(-45deg);
            }
            50% {
                transform: rotateY(-90deg);
            }
            75% {
                transform: rotateY(-135deg);
            }
            100% {
                transform: rotateY(-180deg);
            }
        }

        .page-content {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
        }

        .page-content canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: block;
        }

        .page-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #666;
            font-size: 1.2rem;
            z-index: 5;
        }

        .page-loading .spinner {
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        .page-shadow {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 5px;
        }

        .page.flipping .page-shadow {
            opacity: 1;
        }

        .page.flipping.left .page-shadow {
            background: linear-gradient(to left, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
        }

        .page.flipping.right .page-shadow {
            background: linear-gradient(to right, rgba(0,0,0,0.1) 0%, rgba(0,0,0,0.3) 100%);
        }

        .controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .control-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .control-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .control-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .page-info {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px 25px;
            color: white;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }


        .loading {
            display: none;
            text-align: center;
            color: white;
            font-size: 1.2rem;
            margin: 20px 0;
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .book-spine {
            position: absolute;
            left: 50%;
            top: 5%;
            width: 6px;
            height: 90%;
            background: linear-gradient(to bottom, #8b4513 0%, #654321 50%, #8b4513 100%);
            transform: translateX(-50%);
            z-index: 5;
            box-shadow: inset -2px 0 5px rgba(0,0,0,0.3);
            border-radius: 3px;
        }

        .book-cover {
            position: absolute;
            left: 50%;
            top: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            transform: translateX(-50%);
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            text-align: center;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        .book-cover.hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .book-container {
                height: 400px;
                max-width: 100%;
            }
            
            .controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .upload-section {
                padding: 20px;
            }
        }

        .page-flip-animation {
            animation: pageFlip 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes pageFlip {
            0% {
                transform: rotateY(0deg);
            }
            50% {
                transform: rotateY(-90deg);
            }
            100% {
                transform: rotateY(-180deg);
            }
        }

        .page-reveal-animation {
            animation: pageReveal 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards;
        }

        @keyframes pageReveal {
            0% {
                transform: rotateY(180deg);
            }
            50% {
                transform: rotateY(90deg);
            }
            100% {
                transform: rotateY(0deg);
            }
        }

        .page.flipping.left {
            transform: rotateY(180deg);
        }

        .page.flipping.right {
            transform: rotateY(-180deg);
        }
    </style>
    <!-- GA4 tracking -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-9GT4E8Z0EL"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-9GT4E8Z0EL'); 
    </script>
</head>
<body>
    <div class="header">
        <h1>üìñ 3D PDF Reader</h1>
        <p>Experience PDFs with realistic page flip animations</p>
    </div>

    <div class="upload-section">
        <h3 style="color: white; margin-bottom: 20px;">Upload a PDF file to start reading</h3>
        <div class="file-input-wrapper">
            <input type="file" id="pdfInput" class="file-input" accept=".pdf" />
            <button class="file-input-button">Choose PDF File</button>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Loading PDF...</p>
    </div>

    <div class="pdf-container" id="pdfContainer">
        <div class="controls">
            <button class="control-btn" id="prevBtn">‚Üê Previous</button>
            <button class="control-btn" id="nextBtn">Next ‚Üí</button>
            <button class="control-btn" id="firstBtn">First Page</button>
            <button class="control-btn" id="lastBtn">Last Page</button>
        </div>


        <div class="book-container">
            <div class="book" id="book">
                <div class="book-spine"></div>
                <div class="book-cover" id="bookCover">
                    <div>
                        <h2>üìö PDF Reader</h2>
                        <p>Upload a PDF to start reading</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="page-info" id="pageInfo">
            Page 1 of 1
        </div>

        <div class="keyboard-help" style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 15px; margin: 20px 0; text-align: center; color: white; border: 1px solid rgba(255, 255, 255, 0.2);">
            <h4 style="margin-bottom: 10px;">‚å®Ô∏è Keyboard Controls</h4>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; font-size: 0.9rem;">
                <div><strong>‚Üê ‚Üí</strong> or <strong>‚Üë ‚Üì</strong> Navigate pages</div>
                <div><strong>Home</strong> First page</div>
                <div><strong>End</strong> Last page</div>
            </div>
        </div>
    </div>

    <script>
        class PDF3DReader {
            constructor() {
                this.pdfDoc = null;
                this.currentPage = 1;
                this.totalPages = 0;
                this.isFlipping = false;
                this.pages = [];
                this.renderedPages = new Set();
                this.preloadQueue = [];
                
                this.initializeElements();
                this.attachEventListeners();
                
                // Configure PDF.js
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }

            initializeElements() {
                this.pdfInput = document.getElementById('pdfInput');
                this.loading = document.getElementById('loading');
                this.pdfContainer = document.getElementById('pdfContainer');
                this.book = document.getElementById('book');
                this.bookCover = document.getElementById('bookCover');
                this.pageInfo = document.getElementById('pageInfo');
                this.prevBtn = document.getElementById('prevBtn');
                this.nextBtn = document.getElementById('nextBtn');
                this.firstBtn = document.getElementById('firstBtn');
                this.lastBtn = document.getElementById('lastBtn');
            }

            attachEventListeners() {
                this.pdfInput.addEventListener('change', (e) => this.loadPDF(e.target.files[0]));
                this.prevBtn.addEventListener('click', () => this.previousPage());
                this.nextBtn.addEventListener('click', () => this.nextPage());
                this.firstBtn.addEventListener('click', () => this.goToFirstPage());
                this.lastBtn.addEventListener('click', () => this.goToLastPage());
                
                // Add keyboard event listeners
                document.addEventListener('keydown', (e) => this.handleKeyPress(e));
            }

            async loadPDF(file) {
                if (!file) return;

                this.showLoading();
                this.hideError();

                try {
                    console.log('Loading PDF file:', file.name);
                    const arrayBuffer = await file.arrayBuffer();
                    this.pdfDoc = await pdfjsLib.getDocument(arrayBuffer).promise;
                    this.totalPages = this.pdfDoc.numPages;
                    this.currentPage = 1;
                    this.pages = [];

                    console.log(`PDF loaded successfully. Total pages: ${this.totalPages}`);

                    this.hideLoading();
                    this.showPDFContainer();
                    this.hideBookCover();
                    this.createBookPages();
                    
                    // Wait a bit for DOM to settle
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                    await this.renderCurrentPages();
                    this.updateControls();
                    this.updatePageInfo();
                } catch (error) {
                    console.error('Error loading PDF:', error);
                    this.hideLoading();
                    this.showError('Failed to load PDF: ' + error.message);
                }
            }

            showLoading() {
                this.loading.style.display = 'block';
                this.pdfContainer.style.display = 'none';
            }

            hideLoading() {
                this.loading.style.display = 'none';
            }

            showPDFContainer() {
                this.pdfContainer.style.display = 'flex';
            }

            hideBookCover() {
                this.bookCover.classList.add('hidden');
            }

            showError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error';
                errorDiv.textContent = message;
                this.pdfContainer.appendChild(errorDiv);
            }

            hideError() {
                const errorDiv = this.pdfContainer.querySelector('.error');
                if (errorDiv) {
                    errorDiv.remove();
                }
            }

            createBookPages() {
                // Clear existing pages
                const existingPages = this.book.querySelectorAll('.page');
                existingPages.forEach(page => page.remove());

                console.log(`Creating ${this.totalPages} page elements`);

                // Create page elements
                for (let i = 0; i < this.totalPages; i++) {
                    const page = document.createElement('div');
                    page.className = 'page';
                    page.dataset.pageNumber = i + 1;
                    
                    const pageContent = document.createElement('div');
                    pageContent.className = 'page-content';
                    
                    const canvas = document.createElement('canvas');
                    canvas.style.width = '100%';
                    canvas.style.height = '100%';
                    pageContent.appendChild(canvas);
                    
                    // Add loading indicator
                    const loadingDiv = document.createElement('div');
                    loadingDiv.className = 'page-loading';
                    loadingDiv.innerHTML = `
                        <div class="spinner"></div>
                        <div>Loading page ${i + 1}...</div>
                    `;
                    pageContent.appendChild(loadingDiv);
                    
                    const pageShadow = document.createElement('div');
                    pageShadow.className = 'page-shadow';
                    
                    page.appendChild(pageContent);
                    page.appendChild(pageShadow);
                    this.book.appendChild(page);
                }

                console.log(`Created ${this.book.querySelectorAll('.page').length} page elements`);
            }

            async renderCurrentPages() {
                if (!this.pdfDoc) return;

                const leftPageNum = this.currentPage;
                const rightPageNum = this.currentPage + 1;

                console.log(`Rendering pages: left=${leftPageNum}, right=${rightPageNum}, total=${this.totalPages}`);

                // Clear all pages first
                this.clearAllPages();

                // Render left page
                if (leftPageNum <= this.totalPages) {
                    console.log(`Rendering left page ${leftPageNum}`);
                    await this.renderPage(leftPageNum, 'left');
                }

                // Render right page
                if (rightPageNum <= this.totalPages) {
                    console.log(`Rendering right page ${rightPageNum}`);
                    await this.renderPage(rightPageNum, 'right');
                }

                this.updatePagePositions();
                
                // Start preloading nearby pages
                this.startPreloading();
            }

            clearAllPages() {
                const pages = this.book.querySelectorAll('.page');
                pages.forEach(page => {
                    const canvas = page.querySelector('canvas');
                    if (canvas) {
                        const context = canvas.getContext('2d');
                        context.clearRect(0, 0, canvas.width, canvas.height);
                    }
                });
            }

            async renderPage(pageNum, position) {
                const page = this.book.querySelector(`[data-page-number="${pageNum}"]`);
                if (!page) {
                    console.error(`Page element not found for page ${pageNum}`);
                    return;
                }

                const canvas = page.querySelector('canvas');
                if (!canvas) {
                    console.error(`Canvas not found for page ${pageNum}`);
                    return;
                }

                const loadingDiv = page.querySelector('.page-loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'block';
                }

                const context = canvas.getContext('2d');
                const pdfPage = await this.pdfDoc.getPage(pageNum);
                const viewport = pdfPage.getViewport({ scale: 1.0 });

                // Set canvas size to match the page dimensions
                const pageContent = page.querySelector('.page-content');
                const containerWidth = pageContent.offsetWidth || 400;
                const containerHeight = pageContent.offsetHeight || 600;
                
                // Calculate scale to fit the page in the container
                const scaleX = containerWidth / viewport.width;
                const scaleY = containerHeight / viewport.height;
                const scale = Math.min(scaleX, scaleY);
                
                const scaledViewport = pdfPage.getViewport({ scale: scale });
                
                // Set canvas dimensions
                canvas.width = scaledViewport.width;
                canvas.height = scaledViewport.height;
                canvas.style.width = containerWidth + 'px';
                canvas.style.height = containerHeight + 'px';

                // Clear canvas before rendering
                context.clearRect(0, 0, canvas.width, canvas.height);

                const renderContext = {
                    canvasContext: context,
                    viewport: scaledViewport
                };

                try {
                    await pdfPage.render(renderContext).promise;
                    console.log(`Successfully rendered page ${pageNum} for position ${position}`);
                    
                    // Hide loading indicator
                    if (loadingDiv) {
                        loadingDiv.style.display = 'none';
                    }
                    
                    // Mark page as rendered
                    this.renderedPages.add(pageNum);
                } catch (error) {
                    console.error(`Error rendering page ${pageNum}:`, error);
                    if (loadingDiv) {
                        loadingDiv.innerHTML = '<div>Error loading page</div>';
                    }
                }
            }

            updatePagePositions() {
                const pages = this.book.querySelectorAll('.page');
                pages.forEach((page, index) => {
                    const pageNum = parseInt(page.dataset.pageNumber);
                    page.classList.remove('left', 'right', 'flipping');
                    page.style.transform = '';
                    page.style.display = 'block';
                    page.style.opacity = '1';
                    page.style.animation = '';
                    
                    if (pageNum === this.currentPage) {
                        page.classList.add('left');
                        page.style.zIndex = '2';
                        page.style.left = '2.5%';
                        page.style.right = 'auto';
                    } else if (pageNum === this.currentPage + 1) {
                        page.classList.add('right');
                        page.style.zIndex = '1';
                        page.style.right = '2.5%';
                        page.style.left = 'auto';
                    } else {
                        page.style.display = 'none';
                        page.style.zIndex = '0';
                    }
                });
            }

            async nextPage() {
                if (this.isFlipping || this.currentPage >= this.totalPages) return;
                
                this.isFlipping = true;
                this.updateControls();

                // Animate page flip - flip the right page to reveal next pages
                const rightPage = this.book.querySelector(`[data-page-number="${this.currentPage + 1}"]`);
                if (rightPage) {
                    rightPage.classList.add('flipping');
                }

                // Wait for animation
                await new Promise(resolve => setTimeout(resolve, 600));

                this.currentPage += 2; // Move to next spread (2 pages at a time)
                await this.renderCurrentPages();
                this.updatePageInfo();
                this.isFlipping = false;
                this.updateControls();
            }

            async previousPage() {
                if (this.isFlipping || this.currentPage <= 1) return;
                
                this.isFlipping = true;
                this.updateControls();

                this.currentPage -= 2; // Move to previous spread (2 pages at a time)
                if (this.currentPage < 1) this.currentPage = 1;
                
                await this.renderCurrentPages();

                // Animate page reveal - flip the left page to reveal previous pages
                const leftPage = this.book.querySelector(`[data-page-number="${this.currentPage}"]`);
                if (leftPage) {
                    leftPage.classList.add('flipping');
                }

                // Wait for animation
                await new Promise(resolve => setTimeout(resolve, 600));

                this.updatePageInfo();
                this.isFlipping = false;
                this.updateControls();
            }

            async goToFirstPage() {
                if (this.isFlipping || this.currentPage === 1) return;
                
                this.currentPage = 1;
                await this.renderCurrentPages();
                this.updatePageInfo();
                this.updateControls();
            }

            async goToLastPage() {
                if (this.isFlipping || this.currentPage === this.totalPages) return;
                
                this.currentPage = this.totalPages;
                await this.renderCurrentPages();
                this.updatePageInfo();
                this.updateControls();
            }


            updateControls() {
                this.prevBtn.disabled = this.currentPage <= 1 || this.isFlipping;
                this.nextBtn.disabled = this.currentPage + 1 >= this.totalPages || this.isFlipping;
                this.firstBtn.disabled = this.currentPage === 1 || this.isFlipping;
                this.lastBtn.disabled = this.currentPage + 1 >= this.totalPages || this.isFlipping;
            }

            updatePageInfo() {
                const rightPage = this.currentPage + 1;
                if (rightPage <= this.totalPages) {
                    this.pageInfo.textContent = `Pages ${this.currentPage}-${rightPage} of ${this.totalPages}`;
                } else {
                    this.pageInfo.textContent = `Page ${this.currentPage} of ${this.totalPages}`;
                }
            }

            startPreloading() {
                // Preload next 2 pages and previous 2 pages
                const pagesToPreload = [];
                
                // Next pages
                for (let i = 1; i <= 2; i++) {
                    const nextPage = this.currentPage + 2 + i;
                    if (nextPage <= this.totalPages && !this.renderedPages.has(nextPage)) {
                        pagesToPreload.push(nextPage);
                    }
                }
                
                // Previous pages
                for (let i = 1; i <= 2; i++) {
                    const prevPage = this.currentPage - 2 - i;
                    if (prevPage >= 1 && !this.renderedPages.has(prevPage)) {
                        pagesToPreload.push(prevPage);
                    }
                }
                
                // Preload pages in background
                pagesToPreload.forEach(pageNum => {
                    this.preloadPage(pageNum);
                });
            }

            async preloadPage(pageNum) {
                if (this.renderedPages.has(pageNum)) return;
                
                try {
                    const page = this.book.querySelector(`[data-page-number="${pageNum}"]`);
                    if (!page) return;
                    
                    const canvas = page.querySelector('canvas');
                    if (!canvas) return;
                    
                    const context = canvas.getContext('2d');
                    const pdfPage = await this.pdfDoc.getPage(pageNum);
                    const viewport = pdfPage.getViewport({ scale: 1.0 });
                    
                    const pageContent = page.querySelector('.page-content');
                    const containerWidth = pageContent.offsetWidth || 400;
                    const containerHeight = pageContent.offsetHeight || 600;
                    
                    const scaleX = containerWidth / viewport.width;
                    const scaleY = containerHeight / viewport.height;
                    const scale = Math.min(scaleX, scaleY);
                    
                    const scaledViewport = pdfPage.getViewport({ scale: scale });
                    
                    canvas.width = scaledViewport.width;
                    canvas.height = scaledViewport.height;
                    canvas.style.width = containerWidth + 'px';
                    canvas.style.height = containerHeight + 'px';
                    
                    const renderContext = {
                        canvasContext: context,
                        viewport: scaledViewport
                    };
                    
                    await pdfPage.render(renderContext).promise;
                    this.renderedPages.add(pageNum);
                    console.log(`Preloaded page ${pageNum}`);
                } catch (error) {
                    console.error(`Error preloading page ${pageNum}:`, error);
                }
            }

            handleKeyPress(e) {
                // Only handle keyboard events when PDF is loaded and not flipping
                if (!this.pdfDoc || this.isFlipping) return;
                
                // Prevent default behavior for navigation keys
                if (['ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Home', 'End'].includes(e.key)) {
                    e.preventDefault();
                }
                
                switch (e.key) {
                    case 'ArrowLeft':
                    case 'ArrowUp':
                        this.previousPage();
                        break;
                    case 'ArrowRight':
                    case 'ArrowDown':
                        this.nextPage();
                        break;
                    case 'Home':
                        this.goToFirstPage();
                        break;
                    case 'End':
                        this.goToLastPage();
                        break;
                }
            }
        }

        // Initialize the PDF reader when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new PDF3DReader();
        });
    </script>
</body>
</html>
